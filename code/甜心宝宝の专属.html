<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圈圈の眼睛</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.min.js"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 配置Tailwind主题颜色 - 小马宝莉风格 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pinkie: '#FF6B9B',      // 碧琪粉色
                        rainbow: '#FF8C42',     // 云宝黛西橙色
                        rarity: '#9D65C9',      // 瑞瑞紫色
                        applejack: '#A86432',   // 苹果嘉儿棕色
                        fluttershy: '#D8BFD8',  // 柔柔粉色
                        twilight: '#8B5CF6',    // 紫悦紫色
                        background: '#FFF1F9',  // 粉色背景
                        tvframe: '#D3D3D3',     // 电视框颜色
                        tvbase: '#A9A9A9',      // 电视底座颜色
                    },
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        'tv': '0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 15px rgba(255, 107, 155, 0.5), 0 0 30px rgba(255, 107, 155, 0.3)',
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                },
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            }
            .tv-border {
                border: 8px solid theme('colors.tvframe');
                border-radius: 15px;
                box-shadow: theme('boxShadow.tv');
            }
            .rainbow-gradient {
                background: linear-gradient(90deg, #FF6B9B, #FF8C42, #9D65C9, #8B5CF6);
                background-size: 400% 400%;
                animation: gradient 15s ease infinite;
            }
            .sparkle-animation {
                animation: sparkle 2s infinite;
            }
            .bounce-subtle {
                animation: bounce-subtle 2s infinite;
            }
            .hover-scale {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-scale:hover {
                transform: scale(1.05);
                box-shadow: 0 10px 25px -5px rgba(255, 107, 155, 0.4);
            }
            @keyframes gradient {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
            @keyframes sparkle {
                0%, 100% { opacity: 1; transform: scale(1); }
                50% { opacity: 0.8; transform: scale(1.05); }
            }
            @keyframes bounce-subtle {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px); }
            }
            @keyframes ripple {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                100% {
                    transform: scale(4);
                    opacity: 0;
                }
            }
            .animate-ripple {
                animation: ripple 0.6s ease-out;
            }
        }
    </style>
    
    <!-- 外部字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 全局样式 */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #FFF1F9;
            overflow-x: hidden;
            touch-action: manipulation; /* 防止双击缩放 */
        }

        #video { 
            width: 640px; 
            height: 480px;
            border: 2px solid #333;
            border-radius: 8px;
            /* 设置为不可见但保留功能 */
            opacity: 0;
            position: absolute;
            z-index: -1;
        }
        
        /* 小马宝莉风格装饰 */
        .my-little-pony-decoration {
            position: fixed;
            z-index: -1;
            opacity: 0.6;
        }
        
        /* 使canvas适合电视尺寸 */
        #mainImg {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
            touch-action: none; /* 优化图片上的触摸体验 */
        }
        
        /* 媒体查询 - 移动端优化 */
        @media (max-width: 640px) {
            /* 调整小电视组件大小 */
            #tvContainer {
                max-width: 100%;
            }
            
            /* 调整电视底座和支架 */
            .aspect-video .absolute.-bottom-8 {
                bottom: -6px;
                width: 2/5;
                height: 12px;
            }
            
            .aspect-video .absolute.-bottom-16 {
                bottom: -12px;
                height: 6px;
            }
            
            .aspect-video .absolute.-bottom-16.w-4\/5 {
                height: 2px;
            }
            
            /* 调整电视边框装饰 */
            .tv-border .absolute.w-8.h-8 {
                width: 6px;
                height: 6px;
            }
            
            /* 调整电视控制按钮 */
            .aspect-video .absolute.-top-10 {
                top: -8px;
            }
            
            .aspect-video .w-3.h-3 {
                width: 2px;
                height: 2px;
            }
            
            /* 调整控制面板按钮大小 */
            .grid-cols-3 button {
                font-size: 0.8rem;
                padding: 0.75rem 1rem;
            }
            
            .grid-cols-3 button i {
                display: block;
                margin: 0 auto 0.25rem;
                font-size: 1rem;
            }
            
            /* 调整装饰元素大小 */
            .my-little-pony-decoration {
                display: none;
            }
        }
        
        /* 平板设备优化 */
        @media (min-width: 641px) and (max-width: 1024px) {
            .grid-cols-3 button i {
                display: inline;
            }
        }
        
        /* 禁用在移动设备上的默认行为 */
        button, canvas {
            -webkit-tap-highlight-color: transparent; /* 移除iOS上的点击高亮 */
        }
        
        /* 确保按钮在移动设备上有足够的点击区域 */
        button {
            min-height: 48px;
            min-width: 48px;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-background min-h-screen flex flex-col">
    <!-- 装饰元素 - 小马宝莉风格的背景装饰 -->
    <div class="my-little-pony-decoration top-0 left-0 text-pinkie/20 text-9xl"><i class="fa fa-star"></i></div>
    <div class="my-little-pony-decoration top-20 right-20 text-rainbow/20 text-8xl"><i class="fa fa-heart"></i></div>
    <div class="my-little-pony-decoration bottom-20 left-10 text-rarity/20 text-7xl"><i class="fa fa-magic"></i></div>
    <div class="my-little-pony-decoration bottom-40 right-10 text-twilight/20 text-6xl"><i class="fa fa-star"></i></div>

    <!-- 页面头部 -->
    <header class="w-full py-6 px-4 md:px-8 bg-gradient-to-r from-pinkie/20 via-rainbow/20 to-rarity/20 backdrop-blur-sm">
        <div class="container mx-auto">
            <h1 id="headerText" class="text-[clamp(1.8rem,5vw,2.8rem)] font-bold text-center text-shadow">
                <span id="waitingText" class="text-twilight">稍等一下下~</span>
                <span id="readyText" class="hidden">
                    <span class="text-pinkie">宝宝</span><span class="text-rainbow"></span>
                    <span class="text-rarity">笑一笑</span><span class="text-twilight">~</span>
                </span>
            </h1>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="flex-grow container mx-auto px-4 md:px-8 py-8 flex flex-col items-center justify-center">
        
        <!-- 这里将放置小电视组件 -->
        <div id="tvContainer" class="w-full max-w-2xl mx-auto mb-10">
            <!-- 小电视组件 -->
            <div class="relative w-full aspect-video mx-auto hover-scale">
                <!-- 电视主体 -->
                <div class="relative w-full aspect-video tv-border bg-black overflow-hidden bounce-subtle">
                    <!-- 电视边框装饰 - 小马宝莉风格 -->
                    <div class="absolute top-0 left-0 w-8 h-8 bg-pinkie rounded-br-full opacity-80 sparkle-animation"></div>
                    <div class="absolute top-0 right-0 w-8 h-8 bg-rainbow rounded-bl-full opacity-80 sparkle-animation" style="animation-delay: 0.3s"></div>
                    <div class="absolute bottom-0 left-0 w-8 h-8 bg-rarity rounded-tr-full opacity-80 sparkle-animation" style="animation-delay: 0.6s"></div>
                    <div class="absolute bottom-0 right-0 w-8 h-8 bg-twilight rounded-tl-full opacity-80 sparkle-animation" style="animation-delay: 0.9s"></div>
                    
                    <!-- 电视控制按钮 -->
                    <div class="absolute -top-10 left-1/2 transform -translate-x-1/2 flex space-x-3">
                        <div class="w-3 h-3 bg-pinkie rounded-full animate-pulse"></div>
                        <div class="w-3 h-3 bg-rainbow rounded-full"></div>
                        <div class="w-3 h-3 bg-rarity rounded-full"></div>
                    </div>
                    
                    <!-- 这里将放置canvas元素 -->
                    <div id="canvasContainer" class="w-full h-full">
                        <img id="mainImg" class="w-full h-full object-contain" src="https://sometky.github.io/pics/pinkle.gif" alt="显示内容" />
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页面底部 -->
    <footer class="w-full py-4 px-4 md:px-8 bg-gradient-to-r from-rarity/20 via-twilight/20 to-pinkie/20">
        <div class="container mx-auto text-center text-gray-700">
            <p class="text-sm">© 2025  公主请开心</p>
        </div>
    </footer>

    <video id="video" autoplay muted playsinline></video>

    <!-- JavaScript -->
    <script>
        let isHappy = false;
        let isSystemReady = false;
        const mainImg = document.getElementById('mainImg');
        const waitingText = document.getElementById('waitingText');
        const readyText = document.getElementById('readyText');

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            // 为装饰元素添加随机位置
            const decorations = document.querySelectorAll('.my-little-pony-decoration');
            decorations.forEach(decoration => {
                const randomLeft = Math.random() * 90;
                const randomTop = Math.random() * 90;
                const randomDelay = Math.random() * 5;
                
                decoration.style.left = `${randomLeft}%`;
                decoration.style.top = `${randomTop}%`;
                decoration.style.animationDelay = `${randomDelay}s`;
                decoration.classList.add('animate-float');
            });
            
            // 检测是否为移动设备
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // 为图片设置响应式调整
            function resizeImage() {
                const container = document.getElementById('canvasContainer');
                const rect = container.getBoundingClientRect();
                
                // 防止在移动设备上尺寸过小
                const minSize = isMobile ? 100 : 200;
                const width = Math.max(rect.width, minSize);
                const height = Math.max(rect.height, minSize * 0.75); // 保持4:3比例
                
                // 设置图片的CSS尺寸
                mainImg.style.width = `${width}px`;
                mainImg.style.height = `${height}px`;
            }
            
            // 初始调整图片大小
            resizeImage();

            // 初始隐藏图片
            mainImg.style.opacity = 0;
            fadeInImage();
            
            // 监听窗口大小变化，调整图片大小
            window.addEventListener('resize', resizeImage);
        });
        

        //图片渐变控制
        function fadeInImage() {
            if (isHappy && parseFloat(mainImg.style.opacity) < 1) {
                mainImg.style.opacity = parseFloat(mainImg.style.opacity) + 0.01;
                requestAnimationFrame(fadeInImage);
            }
            else if (!isHappy && parseFloat(mainImg.style.opacity) > 0) {
                mainImg.style.opacity = parseFloat(mainImg.style.opacity) - 0.01;
                requestAnimationFrame(fadeInImage);
            }
        }
        





        //////////////////////////////////////////////////////////////////////////////
        //以下为计算机视觉部分
        const happyCheck = (exp) => {
        if (exp == "happy") {
            isHappy = true;
            fadeInImage();
        } else {
            isHappy = false;
            fadeInImage();
        }
        }

        // 1. 配置模型路径（使用CDN托管的预训练模型，无需本地部署）
        const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';

        // 2. 初始化摄像头
        async function initCamera() {
        try {
            const video = document.getElementById('video');
            // 请求摄像头权限
            const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480 },
            audio: false 
            });
            
            video.srcObject = stream;
            
            // 确保视频完全加载后再返回
            return new Promise((resolve, reject) => {
            // 设置超时保护
            const timeoutId = setTimeout(() => {
                reject(new Error('视频加载超时'));
            }, 5000);
            
            video.onloadedmetadata = () => {
                clearTimeout(timeoutId);
                console.log('视频已加载，尺寸:', video.videoWidth, 'x', video.videoHeight);
                resolve(video);
            };
            
            video.onerror = (error) => {
                clearTimeout(timeoutId);
                reject(new Error('视频加载错误: ' + error.message));
            };
            });
        } catch (error) {
            console.error('摄像头初始化失败:', error);
            document.getElementById('result').innerText = '摄像头访问失败，请确保已授予权限';
            throw error;
        }
        }

        // 3. 加载表情识别模型（含人脸检测+人脸关键点+表情识别）
        async function loadModels() {
        try {
            // 加载必要的模型：ssd_mobilenetv1（人脸检测）、faceLandmark68（关键点）、faceExpression（表情识别）
            await faceapi.nets.ssdMobilenetv1.load(MODEL_URL);
            await faceapi.nets.faceLandmark68Net.load(MODEL_URL);
            await faceapi.nets.faceExpressionNet.load(MODEL_URL);
            return true;
        } catch (error) {
            console.error('模型加载失败:', error);
            alert('模型加载失败，请检查网络连接');
            throw error;
        }
        }

        // 4. 实时表情识别
        async function detectEmotions() {
        const video = document.getElementById('video');

        // 循环检测
        setInterval(async () => {
            try {
            // 动态获取video尺寸，优先使用video实际尺寸，其次使用CSS定义的尺寸
            let width = video.videoWidth || video.width || 640;
            let height = video.videoHeight || video.height || 480;
            
            // 确保尺寸有效
            const displaySize = { 
                width: width > 0 ? width : 640, 
                height: height > 0 ? height : 480 
            };
            
            
            // 直接使用video元素进行检测，保持原有功能逻辑
            const detections = await faceapi.detectAllFaces(video)
                .withFaceLandmarks()
                .withFaceExpressions();

            // 只有当检测到有效内容时才进行尺寸调整和绘制
            if (detections && detections.length > 0) {
                // 解析并展示最高概率的表情
                //const resultEl = document.getElementById('result');
                const expressions = detections[0].expressions;
                // 找到概率最高的表情
                const topEmotion = Object.entries(expressions)
                .sort((a, b) => b[1] - a[1])[0];
                //resultEl.innerText = `当前表情：${topEmotion[0]} (概率：${(topEmotion[1]*100).toFixed(2)}%)`;
                happyCheck(topEmotion[0]);
                console.log(isHappy);
            } else {
                //document.getElementById('result').innerText = '未检测到人脸，请对准摄像头';
            }
            } catch (error) {
            console.error('表情识别出错:', error);
            //document.getElementById('result').innerText = '识别过程中出现错误';
            }
        }, 300); // 每秒检测一次
        }

        


        // 8. 初始化流程
        async function init() {
        try {
            // 先初始化摄像头，确保视频元素可用
            const video = await initCamera();
            
            // 再加载模型
            await loadModels();
            
            // 等待短暂延迟，确保视频流稳定
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // 确保视频尺寸有效后再开始识别
            if (video.videoWidth > 0 && video.videoHeight > 0) {
            //document.getElementById('result').innerText = '开始识别表情...';
            detectEmotions();
            
            // 标记系统就绪并切换显示文本
            isSystemReady = true;
            waitingText.classList.add('hidden');
            readyText.classList.remove('hidden');
            
            } else {
            throw new Error('无法获取有效的视频尺寸');
            }
        } catch (error) {
            console.error('初始化失败:', error);
            //document.getElementById('result').innerText = '初始化失败: ' + error.message;
        }
        }

        // 启动
        window.addEventListener('load', init); // 确保页面完全加载后再初始化
        </script>
    </body>
</html>